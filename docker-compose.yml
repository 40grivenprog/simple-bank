version: '3.9'
services:
    postgres:
      image: postgres:12-alpine
      environment:
        - POSTGRES_USER=root
        - POSTGRES_PASSWORD=secret
        - POSTGRES_DB=simple_bank

    redis:
      image: redis
      ports:
        - "6380:6379"
      command: ["redis-server", "--bind", "0.0.0.0", "--port", "6379"]
    
    api:
      build:
        context: .
        dockerfile: Dockerfile
      ports:
        - "8080:8080"
      environment:
        - DB_SOURCE=postgresql://root:secret@postgres:5432/simple_bank?sslmode=disable
      depends_on:
        - postgres
        - redis
      entrypoint:
        [
          "/app/wait-for.sh",
          "postgres:5432",
          "--",
          "/app/start.sh"
        ]
      command: [ "/app/main" ]
    